+++
date = 2022-05-02T13:00:00Z
title = "–ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä –≤ Python"
description = "–û–±—Ö–æ–¥–∏–º –¥–∞—Ç–∞—Å–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏."
image = "/page-iterator/cover.png"
slug = "page-iterator"
tags = ["development", "ohmypy"]
featured = true
subscribe = "ohmypy"
+++

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –≤—ã¬†—Å—á–∏—Ç–∞–µ—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ¬†–æ–≥—Ä–æ–º–Ω–æ–º—É –¥–∞—Ç–∞—Å–µ—Ç—É –∏–≥—Ä—É—à–µ–∫, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –ø–æ¬†–≤—Å–µ–π —Å—Ç—Ä–∞–Ω–µ –∑–∞¬†–ø—Ä–æ—à–ª—ã–π –≥–æ–¥:

```python
reader = fetch_toys()
for item in reader:
    process_single(item)
```

`process_single()` –∑–∞–Ω–∏–º–∞–µ—Ç 10¬†–º—Å, —Ç–∞–∫ —á—Ç–æ 400¬†–º–ª–Ω –∏–≥—Ä—É—à–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –∑–∞¬†46¬†–¥–Ω–µ–π üò±

–í¬†—Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ–∂–∏–≤–ª–µ–Ω–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –≤–∞–º —É–¥–∞–µ—Ç—Å—è —É–±–µ–¥–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, —á—Ç–æ —Ç–∞–∫ –Ω–µ¬†–æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ. –ù–∞¬†—Å–≤–µ—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `process_batch()`, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 10000 –∏–≥—Ä—É—à–µ–∫ –∑–∞¬†1¬†—Å–µ–∫. –≠—Ç–æ —É–∂–µ 11¬†—á–∞—Å–æ–≤ –Ω–∞¬†–≤—Å–µ –∏–≥—Ä—É—à–∫–∏, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏—è—Ç–Ω–µ–µ.

–ö–∞–∫¬†–±—ã —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–π—Ç–∏ –ø–æ¬†–¥–∞—Ç–∞—Å–µ—Ç—É –ø–∞–∫–µ—Ç–∞–º–∏ –ø–æ¬†10¬†—Ç—ã—Å—è—á –∑–∞–ø–∏—Å–µ–π? –¢—É—Ç –∏¬†–ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä!

## –ù–∞–∏–≤–Ω—ã–π –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∏–∫

–ü—Ä–æ–π–¥–µ–º –ø–æ¬†–∏—Å—Ö–æ–¥–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∑–∞–ø–æ–ª–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü—É. –ö–∞–∫ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è¬†‚Äî –æ—Ç–¥–∞–¥–∏–º —á–µ—Ä–µ–∑ `yield` –∏¬†–Ω–∞—á–Ω–µ–º –∑–∞–ø–æ–ª–Ω—è—Ç—å —Å–ª–µ–¥—É—é—â—É—é. –ë—É–¥–µ–º –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –ø–æ–∫–∞ –∏—Å—Ö–æ–¥–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ¬†–∑–∞–∫–æ–Ω—á–∏—Ç—Å—è:

```python
def paginate(iterable, page_size):
    page = []
    for item in iterable:
        page.append(item)
        if len(page) == page_size:
            yield page
            page = []
    yield page
```

```python
reader = fetch_toys()
page_size = 10_000
for page in paginate(reader, page_size):
    process_batch(page)
```

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—á–∞—è, –Ω–æ¬†–µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∫–∞. –¢–∞–∫–æ–π –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –æ–±—Ö–æ–¥ –∑–∞–º–µ—Ç–Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–±—ã—á–Ω–æ–≥–æ –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ¬†–æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏.

## –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ö–æ–¥–∞

–°—Ä–∞–≤–Ω–∏–º –¥–≤–∞ –æ–±—Ö–æ–¥–∞ ‚Äî –æ–¥–∏–Ω–æ—á–Ω—ã–π –∏¬†–ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π:

```python
def one_by_one(a, b):
    """Processes records one-by-one, without pagination"""
    rdr = reader(a, b)
    for record in rdr:
        process_single(record)

def batch(page_size, a, b):
    """Processes records in batches, with pagination"""
    rdr = reader(a, b)
    for page in paginate(rdr, page_size):
        process_batch(page)

times = 10

page_size = 10_000
a = 1_000_000
b = 2_000_000

fn = lambda: one_by_one(a, b)
total = timeit.timeit(fn, number=times)
it_time = round(total * 1000 / times)
print(f"One-by-one (baseline): {it_time} ms")

fn = lambda: batch(page_size, a, b)
total = timeit.timeit(fn, number=times)
it_time = round(total * 1000 / times)
print(f"Fill page with append(): {it_time} ms")
```

–í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞¬†1¬†–º–ª–Ω –∑–∞–ø–∏—Å–µ–π –∏¬†—Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–∞–∑–º–µ—Ä–æ–º –≤¬†10¬†—Ç—ã—Å—è—á:

```
One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
```

–ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –æ–±—Ö–æ–¥ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø–æ—á—Ç–∏ –≤¬†–ø–æ–ª—Ç–æ—Ä–∞ —Ä–∞–∑–∞!

–î–µ–ª–æ –≤¬†—Ç–æ–º, —á—Ç–æ –Ω–∞¬†–∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ü–∏–∫–ª–∞ –º—ã¬†—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏¬†–∑–∞—Ç–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –µ–≥–æ. –ü–∏—Ç–æ–Ω—É –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞ –ø–æ–¥ —Å–ø–∏—Å–∫–æ–º, –∞¬†—ç—Ç–æ –∑–∞—Ç—Ä–∞—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è¬†‚Äî O(n) –æ—Ç¬†–∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤¬†—Å–ø–∏—Å–∫–µ.

## –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

–ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞—Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã –∏¬†–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü.

```python
def paginate(iterable, page_size):
    page = [None] * page_size
    idx = 0
    for item in iterable:
        page[idx] = item
        idx += 1
        if idx == page_size:
            yield page
            idx = 0
    yield page[:idx]
```

–ü–æ–≤—Ç–æ—Ä–∏–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ:

```
One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
Use fixed-size page:     162 ms
```

–ó–∞–º–µ—Ç–Ω–æ –±—ã—Å—Ç—Ä–µ–µ! –°–∫–æ—Ä–æ—Å—Ç—å —Å—Ä–∞–≤–Ω—è–ª–∞—Å—å —Å –æ–±—ã—á–Ω—ã–º –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–º –ø–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏.

## –ò—Ç–µ—Ä–∞—Ü–∏—è —Å—Ä–µ–∑–∞–º–∏

–ú–æ–∂–Ω–æ¬†–ª–∏ –µ—â—ë –±—ã—Å—Ç—Ä–µ–µ? –ê–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∏¬†‚Äî –Ω–µ—Ç. –ê¬†–≤–æ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏¬†‚Äî –¥–∞, –µ—Å–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –¥–µ–π—Å—Ç–≤–∏–π –∏–∑¬†–∫–æ–¥–∞ –Ω–∞¬†–ø–∏—Ç–æ–Ω–µ –≤¬†–±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –∫–æ–¥ –Ω–∞¬†—Å–∏. –í¬†—ç—Ç–æ–º –ø–æ–º–æ–∂–µ—Ç –º–æ–¥—É–ª—å `itertools()` –∏¬†–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏—è `islice()`:

```python
def paginate(iterable, page_size):
    it = iter(iterable)
    slicer = lambda: list(itertools.islice(it, page_size))
    return iter(slicer, [])
```

–í–æ—Ç —á—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

-   `islice()` —Å–æ–∑–¥–∞—ë—Ç –∏—Ç–µ—Ä–∞—Ç–æ—Ä (–Ω–∞–∑–æ–≤–µ–º –µ–≥–æ —Å–ª–∞–π—Å–µ—Ä–æ–º), –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –µ–º—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø–æ–∫–∞ –Ω–µ¬†–≤—ã–±–µ—Ä–µ—Ç –∏–∑¬†–Ω–µ–µ `page_size` —ç–ª–µ–º–µ–Ω—Ç–æ–≤;
-   `list()` –≤—ã–±–∏—Ä–∞–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑¬†—ç—Ç–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–æ–≥–æ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–∞¬†‚Äî –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞;
-   –ø–æ—Å–∫–æ–ª—å–∫—É `islice()` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–∞, –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—ã–∑–æ–≤–µ –æ–Ω¬†–ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å¬†—Ç–æ–≥–æ¬†–∂–µ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –¥–æ¬†—ç—Ç–æ–≥–æ;
-   –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è `iter(slicer, [])` —Å–æ–∑–¥–∞–µ—Ç –∏—Ç–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞¬†–∫–∞–∂–¥–æ–º —à–∞–≥–µ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–ª–∞–π—Å–µ—Ä;
-   —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Ñ—É–Ω–∫—Ü–∏—è `paginate()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ç–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞¬†–∫–∞–∂–¥–æ–º —à–∞–≥–µ –≤—ã–±–∏—Ä–∞–µ—Ç –æ—á–µ—Ä–µ–¥–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ —Å–ª–∞–π—Å–µ—Ä, –ø—Ä–æ–≤–∏–≥–∞—è—Å—å –ø–æ¬†–æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –ø–æ–∫–∞ –æ–Ω–∞ –Ω–µ¬†–∑–∞–∫–æ–Ω—á–∏—Ç—Å—è.

–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –¥–æ —á–µ–≥–æ —Ö–æ—Ä–æ—à —Ç–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:

```
One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
Use fixed-size page:     162 ms
Use islice:               93 ms
```

–ù–∞ 40%¬†–±—ã—Å—Ç—Ä–µ–µ –æ–±—ã—á–Ω–æ–≥–æ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ¬†–æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏!

## –ò—Ç–æ–≥–æ

–ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –æ–±—Ö–æ–¥ –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ, –≥–¥–µ –ø–∞–∫–µ—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∏–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞–±–æ—Ä–∞ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö. –ß—Ç–æ–±—ã –Ω–µ¬†–ø–∏—Å–∞—Ç—å —Ç–∞–∫–æ–π –æ–±—Ö–æ–¥ –∫–∞–∂–¥—ã–π —Ä–∞–∑ —Å¬†–Ω—É–ª—è, —É–¥–æ–±–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π _–ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä_.

–ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫, —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ¬†‚Äî –∏–∑-–∑–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –º–∞—Å—Å–∏–≤–∞. –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, –∞¬†–µ—â–µ –ª—É—á—à–µ¬†‚Äî –∏—Ç–µ—Ä–∞—Ü–∏—é –Ω–∞¬†–æ—Å–Ω–æ–≤–µ `itertools.islice()`

–†–µ–∫–æ–º–µ–Ω–¥—É—é!

[–ø–µ—Å–æ—á–Ω–∏—Ü–∞](https://replit.com/@antonz/page-iterator#main.py)
