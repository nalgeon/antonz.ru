+++
date = 2022-05-07T17:10:00Z
title = "Вычисляемые столбцы в SQLite"
description = "Чтобы не повторять сложные выражения в каждом запросе."
image = "/generated-columns/cover.png"
slug = "generated-columns"
tags = ["sqlite"]
subscribe = "sqliter"
+++

Иногда поле в запросе рассчитывают на основе других столбцов таблицы. Например, есть столбец `income` с годовым доходом и `tax_rate` с налоговой ставкой:

```
┌────────┬──────────┐
│ income │ tax_rate │
├────────┼──────────┤
│ 70     │ 0.22     │
│ 84     │ 0.22     │
│ 90     │ 0.24     │
└────────┴──────────┘
```

Можно посчитать годовой налог:

```sql
select
  id,
  income * tax_rate as tax
from people;
```

А чтобы не таскать везде это выражение, удобно создать виртуальный _вычисляемый столбец_ (generated column):

```sql
alter table people
add column tax real as (
  income * tax_rate
);
```

После этого столбец можно использовать в запросах точно так же, как обычные столбцы:

```sql
select id, tax
from people;
```

Виртуальные столбцы не хранятся в базе и рассчитываются «на лету». Но по ним вполне можно построить индекс, чтобы ускорить выборку.

> Строго говоря, в SQLite есть _виртуальные_ (virtual) вычисляемые столбцы и *хранимые* (stored). Хранимые сохраняются на диске, но создать их через `alter table` невозможно, поэтому в основном пользуются виртуальными.

В общем виде синтаксис вычисляемых столбцов такой:

```sql
alter table ТАБЛИЦА
add column СТОЛБЕЦ ТИП as (ВЫРАЖЕНИЕ);
```

Вычисляемые столбцы могут использовать любые колонки таблицы, но не другие таблицы и не результаты подзапросов. Оно и к лучшему: для более сложных комбинаций есть _представления_ (views) и *временные таблицы* (temp tables). Но о них как-нибудь в другой раз.

[документация](https://sqlite.org/gencol.html) • [песочница](https://sqlime.org/#gist:5208177f89a0e38ccfae8ead90a35631)
