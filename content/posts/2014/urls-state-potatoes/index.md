+++
date = 2014-05-15T20:44:26Z
title = "Храним состояние в URL"
description = "Чтобы интерфейс не обнулился при рефреше страницы."
image = "/urls-state-potatoes/cover.png"
slug = "urls-state-potatoes"
tags = ["development"]
+++

_Обновленная и дополненная версия от 2022 года_

Если вы разрабатываете веб-приложение, то рано или поздно столкнетесь с проблемой сохранения текущего состояния системы для пользователя.

Например, вы продаете через интернет элитный картофель. Покупатель заходит на сайт и первым делом настраивает условия отбора картофелин:

-   строго из Боливии или ЮАР,
-   урожая 2022 года,
-   размер клубня от 3 до 7 см,
-   желательно в форме морского тюленя.

Получает список из 300 позиций (да, в ЮАР очень популярна картоха в форме тюленя), нарезанный на 6 страниц по 50 элементов каждая. Переходит на третью страницу, открывает карточку картофелины и застывает в немом восхищении на несколько секунд. А потом случайно нажимает на рефреш страницы. Как поступит ваше приложение?

## Не хранить состояние вообще

Допустим, вы не стали заморачиваться с состоянием или храните его в памяти. Тогда при обновлении страницы текущий контекст благополучно потеряется, а пользователя перекинет на главную страницу, где он с негодованием уставится на аршинный заголовок «ЭЛИТНЫЙ КАРТОФЕЛЬ».

Так раньше вел себя гугл-календарь. Как бы вы не перемещались по календарю, какие бы фильтры не накладывали — урл всегда сохранял свой изначальный вид:

    https://www.google.com/calendar/render

Обновляете страницу — и календарь радостно сбрасывает вас на текущую неделю. Удобненько.

## Хранить состояние локально

Большинство сервисов понимает, что терять контекст при обновлении страницы нехорошо. Они запоминают состояние на клиенте (в локал-сторадже или других [браузерных хранилищах](/browser-storage/)). Это решает проблему с рефрешем страницы, но поставить закладку все равно не получится.

Плюс такой подход создает проблему с конфликтующими изменениями состояния. Я открыл две вкладки браузера, зашел на ваш картофельный сайт, и в одной вкладке ищу «картофель молодой», а в другой — «ботва разлапистая». Какой из запросов сохраним?

## Хранить набор GET-параметров

Еще со времен, когда динамическая природа веб-сайтов ограничивалась тегом `<blink>`, хорошим тоном считалось хранить состояние в урле. Такой URL хоть в почту, хоть в закладки — восстановить контекст по нему не проблема:

    https://potato.shop/catalog/?search=wild+potatoes&country=bo,za&size=3-7&page=5

Состояние в урле делает каждую вкладку браузера полностью автономной. Нет общих данных в локальном хранилище — нет и конфликтов. Это упрощает жизнь разработчику, а у пользователя не вскипает мозг от загадочных глюков системы.

## Хранить сериализованное состояние

GET-параметры отлично справляются со скалярными значениями (строками, числами, логическими). Но меньше подходят для коллекций и более сложных структур. Поэтому программисты иногда делают так:

-   представляют состояние в виде словаря;
-   сериализуют его в Base64;
-   записывают одним параметром в URL.

Например, для такого состояния:

```json
{
    "search": "wild potatoes",
    "country": ["bo", "za"],
    "size": { "min": 3, "max": 7 },
    "page": 5
}
```

Получится такой URL:

    https://potato.shop/catalog/?state=eyJzZWFyY2giOiJ3aWxkIHBvdGF0b2VzIiwiY291bnRyeSI6WyJibyIsInphIl0sInNpemUiOnsibWluIjozLCJtYXgiOjd9LCJwYWdlIjo1fQ==

## Гибридные подходы

Можно сохранять в урле только основные параметры, а дополнительные — в локальном хранилище:

    https://potato.shop/catalog/?search=wild+potatoes&page=10

Можно основные параметры передавать явно, а дополнительные — сериализовать:

    https://potato.shop/catalog/?search=wild+potatoes&state=eyJjb3VudHJ5IjpbImJvIiwiemEiXSwic2l6ZSI6eyJtaW4iOjMsIm1heCI6N30sInBhZ2UiOjV9

Встречаются и более творческие варианты.

Например, хранить состояние списка локально, а при переходе к конкретному элементу открывать его в новой вкладке — чтобы не заморачиваться с возвратом к списку.

Или реализовать «короткие ссылки» по принципу bit.ly. Сохранять полное состояние на сервере, генерить для него уникальную ссылку вроде `https://potato.shop/catalog/xKda7`, ее и показывать ее на клиенте.

## Итого

Основные способы сохранения состояния системы в вебе:

-   не хранить вовсе;
-   локальное хранилище;
-   набор GET-параметров;
-   сериализованный словарь.

Лично мне больше всего нравится набор GET-параметров. Но главное, какой бы подход вы не выбрали — сохраняйте и восстанавливайте контекст прозрачно для пользователя.

<div class="row">
<div class="col-xs-12 col-sm-10 col-md-8"><p><em>И подписывайтесь на <span class="nowrap"><i class="fas fa-kiwi-bird"></i> «<a href="https://t.me/ohmypy"><strong>Oh My Py</strong></a>»</span></em></p></div>
</div>
