<!doctype html><html lang=en>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name=yandex-verification content="166c4872c92b3261">
<meta name=google-site-verification content="RDIpvK7QdMQQUb3kxVN3FAjfDdKdfHQSyGVfLb-GaPU">
<title>Оконные функции в картинках</title>
<meta name=description content="Понятное введение в «окошки» для всех, кто анализирует данные в SQL.">
<meta name=robots content="index, follow">
<link rel=stylesheet type=text/css href=/assets/css/style.67f43febd5c60d7010da0cc947743f2774bbbe4c6d9233df29cd694711a1eb61.css>
<link rel=icon href=/assets/favicon/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=/assets/favicon/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=/assets/favicon/favicon-32x32.png>
<link rel=apple-touch-icon href=/assets/favicon/apple-touch-icon.png>
<link rel=mask-icon href=/assets/favicon/safari-pinned-tab.svg>
<meta name=theme-color content="#fff">
<meta name=msapplication-TileColor content="#fff">
<link rel=canonical href=https://antonz.ru/window-functions/>
<meta name=author content="Антон Жиянов">
<meta property="og:site_name" content="Антон Жиянов">
<meta property="og:type" content="article">
<meta property="og:title" content="Оконные функции в картинках">
<meta property="og:description" content="Понятное введение в «окошки» для всех, кто анализирует данные в SQL.">
<meta property="og:url" content="https://antonz.ru/window-functions/">
<meta property="og:image" content="https://antonz.ru/window-functions/cover.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Оконные функции в картинках">
<meta name=twitter:description content="Понятное введение в «окошки» для всех, кто анализирует данные в SQL.">
<meta name=twitter:url content="https://antonz.ru/window-functions/">
<meta name=twitter:site content="@nalgeon">
<meta name=twitter:image content="https://antonz.ru/window-functions/cover.png"></head>
<body>
<div class=header>
<div class=container>
<div class=row>
<div class="col-xs-6 col-sm-3">
<a class=img-link href=/>
<img src=/assets/antonz.jpg class=header-icon>
</a> 
<a href=/>
<strong>Антон Жиянов</strong>
</a>
</div>
<div class="col-xs-12 col-sm-6 col-md-4 hidden-mobile">
<a class=menu__link href=/projects/>
<span>проекты</span>
</a>
<a class=menu__link href=/all/>
<span>блог</span>
</a>
<a class=menu__link href=/#about>
<span>контакты</span>
</a>
<a class=menu__link href=https://antonz.org>
<span>en</span>
</a>
</div>
<div class="col-xs-6 col-sm-3"><div class=search-module>
<form action=https://antonz.ru/search/ method=get target=_self accept-charset=utf-8>
<input type=hidden name=searchid value=2403959>
<input type=hidden name=l10n value=ru>
<input type=hidden name=reqenc>
<input type=search name=text placeholder="поиск по сайту">
</form>
</div></div>
</div>
</div>
</div>
<div class=storey>
<div class=container>
<article class=post>
<div class=row>
<div class="col-xs-12 col-sm-10 article">
<header>
<h1>Оконные функции в картинках</h1>
</header>
<p>Нет более обманчивого раздела SQL, чем «оконные функции». Когда слышишь эти слова, думаешь «наверно, просто придумали какие-то дополнительные функции».</p>
<p>Если вкратце — оконные функции помогают делать классные аналитические отчеты без участия «экселя». Хотите посчитать процент продаж по месяцам от общих продаж за год? Оконные функции. Разделить маркетинговые каналы на эффективные и неэффективные? Оконные функции. Выбрать топ-10 клиентов по каждому сегменту? Тоже они.</p>
<p>Я прочитал несколько десятков статей «для начинающих», которые объясняли, что такое оконные функции. Все они страдали от одной из двух проблем:</p>
<ol>
<li>Все понятно, но описан 1% возможностей «окошек».</li>
<li>Написано так сложно, что если бы я уже не знал предмет обсуждения — ничего бы не понял.</li>
</ol>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img alt=Сложна src=window-wtf.png>
<figcaption>Если не разобраться в запросах с «окошками»,
выглядят они как-то так</figcaption>
</figure>
</div>
</div>
<p>Хочу исправить ситуацию и написать понятное и наглядное введение в оконные функции. Понятное, потому что я умею доходчиво писать о сложных темах. Наглядное — потому что подготовил несколько десятков картинок и гифок, которые помогут понять базовые принципы «окошек».</p>
<p>План такой:</p>
<ol>
<li>Зачем нужны оконные функции (эта статья).</li>
<li><a href=/window-ranking/>Ранжирование</a></li>
<li><a href=/window-offset/>Смещение</a></span></li>
<li><a href=/window-aggregate/>Агрегация</a></span></li>
<li><a href=/window-rolling/>Скользящие агрегаты</a></span></li>
</ol>
<p>Я рекомендую не просто читать статьи, а сразу <a href=https://stepik.org/z/95367><strong>проходить курс</strong></a>. В нем много практических задачек, а только с ними абстрактные знания превратятся в навыки.</p>
<p class=align-center>⌘&nbsp;⌘&nbsp;⌘</p>
<p>Итак, зачем нужны оконные функции? Проще всего объяснять на конкретных примерах. Будем работать с игрушечной таблицей сотрудников, вот такой:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure><img alt="Таблица сотрудников" src=window-employees.png></figure>
</div>
</div>
<p>Рассмотрим некоторые задачи, которые удобно решать с помощью «окошек» в SQL. Как именно их решать — разберемся в следующей части. Пока просто оценим возможности.</p>
<h2 id=1-ранжирование>1. Ранжирование</h2>
<p>Ранжирование — это всевозможные рейтинги, начиная от призеров чемпионата мира по плаванию и заканчивая Forbes 500.</p>
<p>На примере нашей таблички сотрудников:</p>
<p><strong>Общий рейтинг зарплат</strong></p>
<p>Составим рейтинг сотрудников по размеру заработной платы:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure><img alt="Общий рейтинг зарплат" src=window-rank.png></figure>
</div>
</div>
<p>Видно, что у некоторых коллег одинаковая зарплата (Леонид и Марина, Вероника и Григорий) — поэтому они получили один и тот же ранг.</p>
<p><strong>Рейтинг зарплат по департаментам</strong></p>
<p>Тот же рейтинг, только не для всей компании, а по каждому департаменту в отдельности:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure><img alt="Рейтинг зарплат по департаментам" src=window-rank-department.png></figure>
</div>
</div>
<p><strong>Группы по зарплате</strong></p>
<p>Разобьем сотрудников на три группы в зависимости от размера зарплаты:</p>
<ul>
<li>высокооплачиваемые,</li>
<li>средние,</li>
<li>низкооплачиваемые.</li>
</ul>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure><img alt="Группы по зарплате" src=window-rank-bucket.png></figure>
</div>
</div>
<p><strong>Самые «дорогие» коллеги</strong></p>
<p>Найдем самых высокооплачиваемых людей по каждому департаменту:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure><img alt="Самые «дорогие» коллеги" src=window-rank-top.png></figure>
</div>
</div>
<p>Что ж, этим зарплату больше не повышать! (или наоборот, повысить? 🤔)</p>
<h2 id=2-сравнение-сосмещением>2. Сравнение со смещением</h2>
<p>Сравнение со смещением — это когда мы смотрим, в чем разница между соседними значениями. Например, сравниваем страны, которые занимают 5 и 6 место в мировом рейтинге ВВП — сильно ли отличаются? А если сравнить 1 и 6 место?</p>
<p>Сюда же попадают задачи, в которых мы сравниваем значение из набора с границами набора. Например, есть 100 лучших теннисисток мира. Мария Саккари занимает в рейтинге 20 место. Как ее показатели соотносятся с Эшли Бартли, которая занимает 1 место? А с Лин Чжоу, которая занимает 100 место?</p>
<p>На примере нашей таблички сотрудников:</p>
<p><strong>Разница по зарплате с предыдущим</strong></p>
<p>Упорядочим сотрудников по возрастанию зарплаты и проверим, велик ли разрыв между соседями:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure><img alt="Разница по зарплате с предыдущим" src=window-offset-lag.png></figure>
</div>
</div>
<p>Столбец <code>diff</code> показывает, на сколько процентов зарплата сотрудника отличается от предыдущего коллеги. Видно, что больших разрывов нет. Самые крупные — между Дарьей и Борисом (10%) и Мариной и Иваном (13%).</p>
<p><strong>Диапазон зарплат в департаменте</strong></p>
<p>Посмотрим, как зарплата сотрудника соотносится с минимальной и максимальной зарплатой в его департаменте:</p>
<div class=row>
<div class="col-xs-12 col-sm-8">
<figure><img alt="Диапазон зарплат в департаменте" src=window-offset-first-last.png></figure>
</div>
</div>
<p>Для каждого сотрудника столбец <code>low</code> показывает минимальную зарплату родного департамента, а столбец <code>high</code> — максимальную. Видно, что разброс значений в HR и продажах невелик, а у айтишников — значительный.</p>
<h2 id=3-агрегация>3. Агрегация</h2>
<p>Агрегация — это когда мы считаем суммарные или средние показатели. Например, среднюю зарплату по каждому региону или количество золотых медалей у каждой страны в зачете Олимпийских игр.</p>
<p>На примере нашей таблички сотрудников:</p>
<p><strong>Сравнение с фондом оплаты труда</strong></p>
<p>У каждого департамента есть фонд оплаты труда — денежная сумма, которая ежемесячно уходит на выплату зарплат сотрудникам. Посмотрим, какой процент от этого фонда составляет зарплата каждого сотрудника:</p>
<div class=row>
<div class="col-xs-12 col-sm-7">
<figure><img alt="Сравнение с фондом оплаты труда" src=window-aggregate-sum.png></figure>
</div>
</div>
<p>Столбец <code>fund</code> показывает фонд оплаты труда отдела, а <code>perc</code> — долю зарплаты сотрудника от этого фонда. Видно, что в HR и продажах все более-менее ровно, а у айтишников есть заметный разброс зарплат.</p>
<p><strong>Сравнение со средней зарплатой</strong></p>
<p>Интересно, велик ли разброс зарплат в департаментах. Проверим: посчитаем отклонение зарплаты каждого сотрудника от средней по департаменту:</p>
<div class=row>
<div class="col-xs-12 col-sm-8">
<figure><img alt="Сравнение со средней зарплатой" src=window-aggregate-diff.png></figure>
</div>
</div>
<p>Результат подтверждает предыдущие наблюдения: у айтишников зарплаты колеблются от -16% до +20% от среднего, а у остальных департаментов отклонение в пределах 5%.</p>
<h2 id=4-скользящие-агрегаты>4. Скользящие агрегаты</h2>
<p>Скользящие агрегаты — это те же сумма и среднее. Только рассчитывают их не по всем элементам набора, а более хитрым способом.</p>
<p>Поясню на примере. Здесь возьмем другую табличку — с доходами и расходами одного из сотрудников (пусть это будет Марина) за 9 месяцев 2020 года:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure><img alt="Таблица расходов" src=window-expenses.png></figure>
</div>
</div>
<p><strong>Скользящее среднее по расходам</strong></p>
<p>Судя по данным, доходы у Марины растут: 94К ₽ в январе → 104К ₽ в сентябре. А вот растут ли расходы? Сходу сложно сказать, месяц на месяц не приходится. Чтобы сгладить эти скачки, используют «скользящее среднее» — для каждого месяца рассчитывают средний расход с учетом предыдущего и следующего месяца. Например:</p>
<ul>
<li>скользящее среднее за февраль = (январь + февраль + март) / 3;</li>
<li>за март = (февраль + март + апрель) / 3;</li>
<li>за апрель = (март + апрель + май) / 3;</li>
<li>и так далее.</li>
</ul>
<p>Рассчитаем скользящее среднее по всем месяцам:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure><img alt="Скользящее среднее по расходам" src=window-rolling-avg.png></figure>
</div>
</div>
<p>Теперь хорошо видно, что расходы стабильно растут.</p>
<p><strong>Прибыль нарастающим итогом</strong></p>
<p>Мы выяснили, что растут и доходы, и расходы. А как они соотносятся друг с другом? Хочется понять, находится ли человек «в плюсе» или «в минусе» с учетом всех заработанных и потраченных денег.</p>
<p>Причем важно понимать не на конец года, а на каждый месяц. Потому что если по итогам года у Марины все ОК, а в июне ушла в минус — это потенциальная проблема (у компаний такую ситуацию называют «кассовым разрывом»).</p>
<p>Поэтому посчитаем доходы и расходы по месяцам нарастающим итогом (кумулятивно):</p>
<ul>
<li>кумулятивный доход за январь = январь;</li>
<li>за февраль = январь + февраль;</li>
<li>за март = январь + февраль + март;</li>
<li>за апрель = январь + февраль + март + апрель;</li>
<li>и так далее.</li>
</ul>
<div class=row>
<div class="col-xs-12 col-sm-10">
<figure><img alt="Прибыль нарастающим итогом" src=window-cumulative-sum.png></figure>
</div>
</div>
<p>Теперь видно, что дела у Марины идут неплохо. В некоторых месяцах расходы превышают доходы, но благодаря накопленной «денежной подушке» кассового разрыва не происходит.</p>
<h2 id=резюме>Резюме</h2>
<p>Вот задачи, которые непринужденно решаются с помощью оконных функций в SQL:</p>
<ol>
<li>Ранжирование (всевозможные рейтинги).</li>
<li>Сравнение со смещением (соседние элементы и границы).</li>
<li>Агрегация (сумма и среднее).</li>
<li>Скользящие агрегаты (сумма и среднее в динамике).</li>
</ol>
<p>Конечно, это не исчерпывающий список. Но, надеюсь, теперь понятно, как пригодятся оконные функции в аналитике данных. В <a href=/window-ranking/>следующей части</a> разберемся, что такое «окно» и как работает оконная функция.</p>
<p>Чтобы закрепить знания на практике — <a href=https://stepik.org/z/95367><strong>записывайтесь на курс</strong></a> 🚀</p>
</div>
</div><footer class=post__footer>
<div class=row>
<div class=col-xs-12>
<div class=post__date>
<time datetime="2021-03-15 09:20:42 +0000 UTC">15.03.2021</time>
</div>
<div class=post__tags>
<a href=https://antonz.ru/tags/data/>данные</a>&nbsp;
<a href=https://antonz.ru/tags/sqlite/>sqlite</a>&nbsp;
</div>
</div>
</div>
</footer></article>
<aside class=post__related>
<div class="post__nav article">
<div class=row>
<div class="col-xs-12 col-sm-6">
<p>&larr;&nbsp;<a href=https://antonz.ru/episode-4/>Ошибки в API</a></p>
</div>
<div class="col-xs-12 col-sm-6">
<p><a href=https://antonz.ru/start-with-example/>Начни с примера</a>&nbsp;&rarr;</p>
</div>
</div>
</div>
<div class=article>
<div class=row>
<div class="col-xs-12 col-sm-8 col-md-6">
<h3>Ещё по теме</h3>
<p><a href=/sqlite-3-35/>Что нового в SQLite 3.35</a></p>
<p><a href=/random-table/>Как создать таблицу на 1М записей одним запросом</a></p>
<p><a href=/sqlite-course/>SQLite для аналитики</a></p>
</div>
</div>
</div>
</aside>
<script src=https://utteranc.es/client.js repo=nalgeon/comments.antonz.ru issue-term=pathname theme=github-light crossorigin=anonymous async></script></div>
</div>
<footer class="container footer">
<ul class=naked-list>
<li class=footer__item>Подписаться:
<a href=https://twitter.com/nalgeon class=footer__social-link><i class="fab fa-twitter"></i><span>Твиттер</span></a>
<a href=https://www.facebook.com/nalgeon class=footer__social-link><i class="fab fa-facebook-f"></i><span>Фейсбук</span></a>
<a href=/rss class=footer__social-link><i class="fas fa-rss"></i><span>RSS</span></a>
</li>
<li class=footer__item>Почта: <a href=mailto:m@antonz.ru>m@antonz.ru</a></li>
<li class=footer__item>и приходите в
<a class=footer__link href=https://career.hflabs.ru/>HFLabs</a>
</li>
</ul>
</footer>
<script async src=//gc.zgo.at/count.js data-goatcounter=https://antonzru.goatcounter.com/count></script></body>
</html>